<div class="page-container">
  <div class="page-header">
    <h2><i class="pi pi-history"></i> Checking History</h2>
    <button pButton label="Check IN" icon="pi pi-sign-in" (click)="openCheckIn()"
            *ngIf="auth.hasPermission('checking')"></button>
  </div>

  <p-table #dt [value]="history" [paginator]="true" [rows]="10" styleClass="p-datatable-sm"
           [globalFilterFields]="['action','firstName','lastName','phoneNumber','book.title','book.author']">
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="id">ID <p-sortIcon field="id"></p-sortIcon></th>
        <th pSortableColumn="action">Action <p-sortIcon field="action"></p-sortIcon></th>
        <th pSortableColumn="date">Date <p-sortIcon field="date"></p-sortIcon></th>
        <th>Book Title</th>
        <th>Book Author</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Phone</th>
        <th>Out</th>
        <th style="width:80px">Actions</th>
      </tr>
      <tr>
        <th></th>
        <th><input pInputText type="text" (input)="dt.filter($any($event.target).value, 'action', 'contains')" placeholder="Filter" style="width:100%" /></th>
        <th><input pInputText type="text" (input)="dt.filter($any($event.target).value, 'date', 'contains')" placeholder="Filter" style="width:100%" /></th>
        <th><input pInputText type="text" (input)="dt.filter($any($event.target).value, 'book.title', 'contains')" placeholder="Filter" style="width:100%" /></th>
        <th><input pInputText type="text" (input)="dt.filter($any($event.target).value, 'book.author', 'contains')" placeholder="Filter" style="width:100%" /></th>
        <th><input pInputText type="text" (input)="dt.filter($any($event.target).value, 'firstName', 'contains')" placeholder="Filter" style="width:100%" /></th>
        <th><input pInputText type="text" (input)="dt.filter($any($event.target).value, 'lastName', 'contains')" placeholder="Filter" style="width:100%" /></th>
        <th><input pInputText type="text" (input)="dt.filter($any($event.target).value, 'phoneNumber', 'contains')" placeholder="Filter" style="width:100%" /></th>
        <th></th>
        <th></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-entry>
      <tr>
        <td>{{ entry.id }}</td>
        <td>
          <span [class]="entry.action === 'IN' ? 'badge-in' : 'badge-out'">{{ entry.action }}</span>
        </td>
        <td>{{ entry.date | date:'yyyy-MM-dd HH:mm' }}</td>
        <td>{{ entry.book?.title }}</td>
        <td>{{ entry.book?.author }}</td>
        <td>{{ entry.firstName }}</td>
        <td>{{ entry.lastName }}</td>
        <td>{{ entry.phoneNumber }}</td>
        <td>
          <span [class]="entry.out ? 'badge-active' : 'badge-returned'">{{ entry.out ? 'Yes' : 'No' }}</span>
        </td>
        <td>
          <button *ngIf="canCheckOut(entry)" pButton icon="pi pi-sign-out"
                  class="p-button-text p-button-warning p-button-sm"
                  (click)="confirmCheckOut(entry)" pTooltip="Check OUT"></button>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr><td colspan="10" class="text-center">No history entries</td></tr>
    </ng-template>
  </p-table>
</div>

<!-- Check IN Dialog -->
<p-dialog header="Check IN - Borrow Book" [(visible)]="showCheckInDialog" [modal]="true" [style]="{ width: '500px' }" (onShow)="onDialogShow()">
  <div class="dialog-form">
    <!-- <div class="field">
      <label>Search Book</label>
      <input #bookFilterInput type="text" pInputText [(ngModel)]="bookFilter" placeholder="Filter books by title..." />
    </div> -->
    <div class="field">
      <label>Select Book</label>
      <p-dropdown [options]="filteredAvailableBooks" [(ngModel)]="selectedBook"
                  optionLabel="title" [filter]="true" filterBy="title,name"
                  placeholder="Select a book" [style]="{ width: '100%' }"></p-dropdown>
    </div>
    <div class="field">
      <label>First Name</label>
      <input type="text" pInputText [(ngModel)]="firstName" placeholder="Borrower first name" />
    </div>
    <div class="field">
      <label>Last Name</label>
      <input type="text" pInputText [(ngModel)]="lastName" placeholder="Borrower last name" />
    </div>
    <div class="field">
      <label>Phone Number</label>
      <input type="text" pInputText [(ngModel)]="phoneNumber" placeholder="Phone number" />
    </div>
  </div>
  <ng-template pTemplate="footer">
    <button pButton label="Cancel" icon="pi pi-times" class="p-button-text" (click)="showCheckInDialog = false"></button>
    <button pButton label="Save" icon="pi pi-check" (click)="saveCheckIn()"></button>
  </ng-template>
</p-dialog>
